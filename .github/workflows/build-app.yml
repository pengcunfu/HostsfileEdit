name: Build Windows Application

on:
  push:
    tags: ['v*']
  pull_request:
    paths: ['main.py', 'requirements.txt']
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name "HostsFileEditor" main.py
        
    - name: Test executable exists
      run: |
        if (Test-Path "dist\HostsFileEditor.exe") {
          Write-Host "✅ 可执行文件创建成功"
          Get-Item "dist\HostsFileEditor.exe" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Error "❌ 可执行文件创建失败"
          exit 1
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HostsFileEditor-Windows-${{ github.sha }}
        path: dist/HostsFileEditor.exe
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/HostsFileEditor.exe
        name: Hosts文件编辑工具 ${{ github.ref_name }}
        body: |
          ## Hosts文件编辑工具 - ${{ github.ref_name }}
          
          ### 📥 下载
          - **Windows可执行文件**: `HostsFileEditor.exe`
          - **文件大小**: 约 25MB
          - **系统要求**: Windows 7/8/10/11
          - **运行要求**: **必须以管理员权限运行**
          
          ### 🚀 使用方法
          1. 下载 `HostsFileEditor.exe` 文件
          2. **右键选择"以管理员身份运行"**
          3. 开始编辑您的hosts文件！
          
          ### ✨ 主要功能
          - 🎨 现代化GUI界面（基于PySide6）
          - 🔄 双重编辑模式（文本编辑 + 按条编辑）
          - 🛡️ 智能权限检测和安全保护
          - 🔧 便民工具集（文件定位、记事本集成、环境变量）
          - ✅ IP地址格式验证
          
          ### ⚠️ 重要提醒
          - **必须以管理员权限运行**才能修改hosts文件
          - 首次运行可能被杀毒软件误报，请添加信任
          - 建议使用前备份原始hosts文件
          - 修改后执行 `ipconfig /flushdns` 刷新DNS缓存
          
          ### 🔗 相关链接
          - **完整源码**: [GitHub仓库](https://github.com/${{ github.repository }})
          - **使用文档**: [项目README](https://github.com/${{ github.repository }}#readme)
          - **问题反馈**: [提交Issue](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          **感谢使用Hosts文件编辑工具！如果对您有帮助，请给个⭐Star支持！**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}